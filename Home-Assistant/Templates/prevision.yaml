- trigger:
    # Actualiza la previsi√≥n cada hora (AEMET no actualiza tan r√°pido, pero es seguro)
    - platform: time_pattern
      hours: /1
    # Se asegura de actualizar al iniciar Home Assistant
    - platform: homeassistant
      event: start
  action:
    # Llama al servicio para obtener la previsi√≥n DIARIA de AEMET
    - action: weather.get_forecasts
      data:
        type: daily
      target:
        entity_id: weather.aemet # <--- Tu entidad de AEMET
      response_variable: aemet_daily # <-- Almacenamos la previsi√≥n aqu√≠
      
  sensor:
    # Sensor principal que almacena toda la lista de previsi√≥n en un atributo
    - name: AEMET Forecast, Diario
      unique_id: aemet_forecast_diario
      state: "{{ now().isoformat() }}" # El estado es solo la marca de tiempo de la √∫ltima actualizaci√≥n
      attributes:
        # Aqu√≠ almacenamos la lista completa de la previsi√≥n de AEMET
        forecast: "{{ aemet_daily['weather.aemet'].forecast }}"
# Bloque de extracci√≥n que lee del sensor de atributo creado arriba
- sensor:
    # Definimos la variable 'manana' a partir del atributo del sensor que creamos
    - variables:
        # Accede a la lista de previsi√≥n y selecciona el √≠ndice [1] (Ma√±ana)
        manana: "{{ state_attr('sensor.aemet_forecast_diario', 'forecast')[1] }}"
        
    # 1. ‚òÅÔ∏è Condici√≥n del Tiempo Ma√±ana
    - name: "AEMET Condici√≥n Ma√±ana"
      unique_id: "aemet_condition_day1"
      state: "{{ manana.condition | replace('_', ' ') | capitalize }}"
      icon: mdi:weather-cloudy
      
    # 2. ‚¨ÜÔ∏è Temperatura M√°xima Ma√±ana
    - name: "AEMET Temperatura M√°x Ma√±ana"
      unique_id: "aemet_temp_max_day1"
      unit_of_measurement: "¬∞C"
      device_class: temperature
      state: "{{ manana.temperature | round(1) }}" 

    # 3. ‚¨áÔ∏è Temperatura M√≠nima Ma√±ana
    - name: "AEMET Temperatura M√≠n Ma√±ana"
      unique_id: "aemet_temp_min_day1"
      unit_of_measurement: "¬∞C"
      device_class: temperature
      state: "{{ manana.templow | round(1) }}" 
          
    # 4. üåßÔ∏è Probabilidad de Precipitaci√≥n Ma√±ana
    - name: "AEMET Probabilidad Lluvia Ma√±ana"
      unique_id: "aemet_precip_prob_day1"
      unit_of_measurement: "%"
      device_class: humidity
      state: "{{ manana.precipitation_probability | round(0) }}"
