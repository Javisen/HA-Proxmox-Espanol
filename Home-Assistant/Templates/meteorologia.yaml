# templates/meteorologia.yaml

- sensor:
    
    # =================================================================
    # 1. Clima en Castellano (Traducci√≥n y Atributos de weather.xxx)
    # =================================================================
    - name: "Clima en Castellano"
      state: >
        {% set condition = states('sensor.aemet_condition') %}
        {% if condition == 'clear' %}
          Despejado
        {% elif condition == 'cloudy' %}
          Nublado
        {% elif condition == 'partlycloudy' %}
          Parcialmente nublado
        {% elif condition == 'rainy' %}
          Lluvia
        {% elif condition == 'pouring' %}
          Lluvia Torrencial
        {% elif condition == 'snow' %}
          Nieve
        {% elif condition == 'fog' %}
          Niebla üå´Ô∏è
        {% elif condition == 'storm' %}
          Tormenta
        {% elif condition == 'windy' %}
          Ventoso
        {% elif condition == 'sunny' %}
          Soleado
        {% elif condition == 'clear-night' %}
          Noche Despejada
        {% else %}
          Condici√≥n desconocida
        {% endif %}
        
      # attributes: reemplaza a attribute_templates:
      attributes:
        temperatura: "{{ state_attr('weather.openweathermap', 'temperature') | round(1) }}¬∞"
        sensaci√≥n_t√©rmica: "{{ state_attr('weather.openweathermap', 'apparent_temperature') | round(1) }}¬∞"
        humedad: "{{ state_attr('weather.openweathermap', 'humidity') }} %"
        nubosidad: "{{ state_attr('weather.openweathermap', 'cloud_coverage') }} %"
        presi√≥n: "{{ state_attr('weather.openweathermap', 'pressure') }} {{ state_attr('weather.openweathermap', 'pressure_unit') }}"
        velocidad_viento: "{{ state_attr('weather.openweathermap', 'wind_speed') | round(1) }} {{ state_attr('weather.openweathermap', 'wind_speed_unit') }}"
        r√°faga_viento: "{{ state_attr('weather.openweathermap', 'wind_gust_speed') | round(1) }} {{ state_attr('weather.openweathermap', 'wind_speed_unit') }}"
        direcci√≥n_viento: >
          {% set direction = state_attr('weather.openweathermap', 'wind_bearing') | float(0) %}
          {% if direction <= 22.5 or direction > 337.5 %} Norte
          {% elif direction > 22.5 and direction <= 67.5 %} Noreste
          {% elif direction > 67.5 and direction <= 112.5 %} Este
          {% elif direction > 112.5 and direction <= 157.5 %} Sureste
          {% elif direction > 157.5 and direction <= 202.5 %} Sur
          {% elif direction > 202.5 and direction <= 247.5 %} Suroeste
          {% elif direction > 247.5 and direction <= 292.5 %} Oeste
          {% else %} Noroeste
          {% endif %}
        
        visibilidad: "{{ state_attr('weather.openweathermap', 'visibility') }} {{ state_attr('weather.openweathermap', 'visibility_unit') }}"
        origen_datos: "{{ state_attr('weather.openweathermap', 'attribution') }}"
        
    # =================================================================
    # 2. Temperatura Media (C√°lculo de promedio)
    # =================================================================
    - name: "Temperatura zona media" 
      unique_id: "temperature_zone_average"
      unit_of_measurement: "¬∞C"
      state: >
        {% set temp_1 = state_attr('weather.gandia', 'temperature') | float(0) %}
        {% set temp_2 = state_attr('weather.gandia_ajuntament', 'temperature') | float(0) %}
        {{ ((temp_1 + temp_2) / 2) | round(1) }}
        


# =================================================================
# 3. Sensaci√≥n T√©rmica Calculada
# =================================================================
    - name: "Sensaci√≥n T√©rmica"
      unique_id: "calculated_thermal_sensation"
      icon: mdi:temperature-minus
      unit_of_measurement: '¬∞C'
      state: >
        {# F√≥rmula de 'temperatura aparente' o sensaci√≥n t√©rmica (√≠ndice de calor y fr√≠o) #}
        {% set temperature = state_attr('weather.gandia_ajuntament', 'temperature') | float(0) %}
        {% set humidity = state_attr('weather.gandia_ajuntament', 'humidity') | float(0) %}
        {# Convertir km/h a m/s (dividir por 3.6) #}
        {% set windspeedmps = state_attr('weather.gandia_ajuntament', 'wind_speed') | float(0) / 3.6 %}
        
        {# C√°lculo de la Presi√≥n de Vapor de Agua (wvp) #}
        {% set wvp = (humidity/100) * 6.105 * e**((17.27*temperature) / (237.7 + temperature)) %}
        
        {# Aplicaci√≥n de la f√≥rmula #}
        {{ (temperature + 0.33 * wvp - 0.70 * windspeedmps - 4.00) | round(2) }}
        
# templates/meteorologia.yaml
